<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Capitol League — Votes</title>
<link rel="stylesheet" href="shared.css"/>
<style>
  :root{--max:1280px;--g:16px;--bg:#0f1220;--txt:#e7e9f4;--muted:#a7afd3;
    --panel:#11162c;--panel-2:#0c1226;--line:rgba(255,255,255,.1);--h:72px;--shadow:0 16px 36px rgba(0,0,0,.35);
    --red:#e06161;--red-2:#a53c3c;--green:#5bd39b;--green-2:#218c62;--blue:#6ea8fe;--blue-2:#254a9c;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  main.shell{max-width:var(--max);margin:0 auto;padding:12px var(--g) 56px}
  .toolbar{position:sticky;top:var(--h);z-index:9;background:linear-gradient(180deg,rgba(13,17,33,.98),rgba(13,17,33,.96));
    border-top:1px solid rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.07)}
  .toolbar-inner{max-width:var(--max);margin:0 auto;padding:10px var(--g);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .input{height:38px;border-radius:12px;padding:0 12px;font-weight:700;color:#cfe3ff;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));
    border:1px solid rgba(255,255,255,.1)} .input::placeholder{color:#8fa1d6} .input:focus{outline:none;box-shadow:0 0 0 2px rgba(110,168,254,.28)}
  .grow{flex:1;min-width:260px} select.input option{background:#0f142b;color:#e7e9f4}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.14);color:var(--txt);background:linear-gradient(180deg,rgba(255,255,255,.09),rgba(255,255,255,.06));
    height:38px;border-radius:12px;padding:0 14px;font:800 13px/38px system-ui;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .btn:hover{filter:brightness(1.07)} .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.5;cursor:default}
  .pill{display:inline-block;padding:8px 12px;border-radius:999px;font:900 12px/1 system-ui;border:1px solid rgba(0,0,0,.25)}
  .pill.pass{background:linear-gradient(180deg,var(--green),var(--green-2));color:#081a11}
  .pill.fail{background:linear-gradient(180deg,var(--red),var(--red-2));color:#1c0909}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;font:800 12px/1 system-ui;color:#d7e2ff;background:linear-gradient(180deg,#1b2344,#131a34);border:1px solid rgba(110,168,254,.30)}
  details.year{margin-top:18px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#0e1328,#0d1225)}
  details.year>summary{list-style:none;cursor:pointer;user-select:none;padding:10px 12px;font:900 13px system-ui;display:flex;align-items:center;justify-content:space-between;color:#cbd3ff}
  details.year>summary::-webkit-details-marker{display:none} .year-count{color:#8fa1d6;font-weight:800}
  details.month{margin:4px 8px 10px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#0f142b,#0e1326)}
  details.month>summary{list-style:none;cursor:pointer;user-select:none;padding:10px 12px;font:900 12px system-ui;color:#c7cff7}
  details.month>summary::-webkit-details-marker{display:none}
  .list{display:flex;flex-direction:column;gap:14px;margin:8px}
  details.acc{background:linear-gradient(180deg,#0f142b,#0e1326);border-radius:18px;position:relative;box-shadow:var(--shadow);overflow:hidden}
  summary.acc-hd{list-style:none;display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:14px 16px;cursor:pointer;user-select:none;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
  summary.acc-hd::-webkit-details-marker{display:none}
  .acc-main{display:flex;gap:10px;align-items:flex-start;min-width:0;flex:1}
  .caret{display:grid;place-items:center;width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);font-size:12px;margin-top:2px;transform:rotate(0);transition:transform .15s ease}
  details[open] .caret{transform:rotate(90deg)}
  .acc-title{font:900 15px/1.35 system-ui;margin:0}.acc-sub{color:#a7afd3;font:700 12px/1.2 system-ui;margin-top:6px}
  .acc-badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:12px}
  .acc-wrap{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(.2,.6,.2,1)} .acc-body{border-top:1px solid var(--line)}
  .acc-sec{padding:14px 16px;border-top:1px solid var(--line)}
  .summary{background:linear-gradient(180deg,#0f1a3a,#0e1733);border-radius:14px;padding:12px;border:1px solid rgba(160,190,255,.20)}
  .meta-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .meta{background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,.09)}
  .meta-label{color:#a7afd3;font:800 11px/1 system-ui;letter-spacing:.25px;margin-bottom:6px;text-transform:uppercase}
  .ynbar{display:grid;gap:8px}.ynbar .stack{display:flex;height:14px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:#0b1022}
  .ynbar .seg{height:100%}.ynbar .seg.Y{background:linear-gradient(180deg,var(--blue),var(--blue-2))}.ynbar .seg.N{background:linear-gradient(180deg,var(--red),var(--red-2))}
  .ynbar .labels{display:flex;justify-content:space-between;font:800 11px/1 system-ui;color:#a7afd3}
  @media (max-width:900px){summary.acc-hd{flex-direction:column}.acc-badges{margin:8px 0 0 26px}.meta-grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.meta-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="site-header"></div>

<main class="shell">
  <h1 style="font:900 20px/1.2 system-ui;margin:6px 0 8px">Recent Votes</h1>
  <div style="color:#a7afd3;font:600 13px/1.4 system-ui;margin-bottom:12px">
    Live House & Senate votes — expandable bill details with official .gov sources.
  </div>

  <div class="toolbar">
    <div class="toolbar-inner">
      <input id="q" class="input grow" placeholder="Search bill title, number, or question…"/>
      <select id="chamber" class="input">
        <option value="">All Chambers</option>
        <option value="house">House</option>
        <option value="senate">Senate</option>
      </select>
      <select id="resultFilter" class="input">
        <option value="">All results</option>
        <option value="pass">Passed / Agreed</option>
        <option value="fail">Failed / Rejected / Tabled</option>
      </select>
      <select id="sortSel" class="input">
        <option value="-created" selected>Sort: Newest</option>
        <option value="created">Sort: Oldest</option>
      </select>
      <button id="clearBtn" class="btn">Clear all</button>
      <span id="rangeNote" style="color:#8fa1d6;font-weight:800;margin-left:auto"></span>
      <span id="debugNote" style="color:#8fa1d6;font-weight:700"></span>
    </div>
  </div>

  <div id="years"></div>

  <div class="toolbar" style="margin-top:12px">
    <div class="toolbar-inner">
      <button id="prevBtn" class="btn" disabled>◀ Newer</button>
      <button id="nextBtn" class="btn">Older ▶</button>
      <span id="pageNote" style="color:#8fa1d6;font-weight:800"></span>
    </div>
  </div>
</main>

<script defer src="shared.js"></script>
<script>
(function(){
  if (window.__votesInit) return; window.__votesInit = true;

  const yearsEl = document.getElementById('years');
  const q = document.getElementById('q');
  const chamberSel = document.getElementById('chamber');
  const resultSel = document.getElementById('resultFilter');
  const sortSel = document.getElementById('sortSel');
  const clearBtn = document.getElementById('clearBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const rangeNote = document.getElementById('rangeNote');
  const debugNote = document.getElementById('debugNote');
  const pageNote = document.getElementById('pageNote');

  const LIMIT = 50;
  let offset = 0;
  let reachedEnd = false;
  let emptyStreak = 0;

  const now = new Date();
  const nowYear = now.getFullYear();
  const nowMonthKey = `${nowYear}-${String(now.getMonth()+1).padStart(2,'0')}`;

  const esc = s => (s || "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const D = t => t ? new Date(t) : null;
  const fmt = t => { const x = D(t); return x ? x.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}) : ""; };
  const fmtDT = t => { const x = D(t); return x ? x.toLocaleString(undefined,{year:'numeric',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : ""; };

  const PASS = ['pass','passed','agreed','confirmed','cloture invoked','cloture motion agreed','motion agreed','resolution agreed','conference report agreed','veto overridden','on passage passed'];
  const FAIL = ['fail','failed','rejected','not agreed','tabled','veto sustained','cloture rejected','motion to proceed rejected'];
  const isPass = r => { const s=(r||'').toLowerCase(); if (FAIL.some(x=>s.includes(x))) return false; if (PASS.some(x=>s.includes(x))) return true; return false; };
  const pill = r => `<span class="pill ${isPass(r)?'pass':'fail'}">${esc(r||'—')}</span>`;

  function normalizeGovtrack(objs){
    return objs.map(o=>{
      const roll = o.number || o.roll || o.roll_call || o.rollnumber || null;
      const billNum = (o.bill && (o.bill.display_number || o.bill.number)) || o.related_bill?.display_number || o.nomination?.number || o.roll?.display_number || o.number || "";
      const title = (o.bill && o.bill.title) || "";
      const question = o.question || o.question_text || "";
      const voteType = o.vote_type || o.category || o.category_label || '';
      const required = o.required || o.required_threshold || o.threshold || '';
      const p = (o.total?.present)||0, nv=(o.total?.not_voting||o.total?.Other)||0;
      const yeas = (o.total_plus ?? o.total_yes ?? o.yea ?? o.total?.yes ?? o.total?.Yea) || 0;
      const nays = (o.total_minus ?? o.total_no ?? o.nay ?? o.total?.no ?? o.total?.Nay) || 0;
      return {
        id: o.id,
        roll,
        created: o.created || o.updated,
        chamber: (o.chamber || "").toLowerCase()==='senate' ? 'Senate' : 'House',
        billNum, billTitle: title,
        summary: o.bill?.summary || o.bill?.summary_short || o.nomination?.description || question,
        question, voteType, required, present:+p||0, notvoting:+nv||0,
        result: o.result || o.result_label || '—',
        link: o.link || o.source_url || '',
        yeas:+yeas||0, nays:+nays||0
      };
    });
  }

  // Congress.gov (via our proxy) already normalized on the server.
  function renderYN(v){
    const t = v.yeas + v.nays; if (!t) return "";
    const yp = Math.round((v.yeas/t)*100), np = 100-yp, m = v.yeas-v.nays, s = m>0?'+':'';
    return `<div class="ynbar">
      <div class="stack"><div class="seg Y" style="width:${yp}%"></div><div class="seg N" style="width:${np}%"></div></div>
      <div class="labels"><span>Yeas ${v.yeas} (${yp}%)</span><span>Margin ${s}${m}</span><span>Nays ${v.nays} (${np}%)</span></div>
    </div>`;
  }
  function govPrimaryLink(v){
    if (v.link) return v.link; // proxy already gave Congress.gov link
    // Senate primary (.gov) if needed:
    if (v.chamber === 'Senate' && v.roll && v.created){
      const d = new Date(v.created), yr = d.getUTCFullYear();
      const congress = Math.floor((yr - 1789)/2)+1, session = (yr % 2 === 1) ? 1 : 2;
      const roll5 = String(parseInt(v.roll,10)).padStart(5,'0');
      return `https://www.senate.gov/legislative/LIS/roll_call_votes/vote${congress}${session}/vote_${congress}_${session}_${roll5}.htm`;
    }
    return "";
  }

  function card(v){
    const title = v.billTitle || v.question || "Untitled vote";
    const primary = govPrimaryLink(v);
    return `
    <details class="acc" data-id="${v.id}">
      <summary class="acc-hd">
        <div class="acc-main">
          <div class="caret">▶</div>
          <div style="min-width:0">
            <h2 class="acc-title">${esc(title)}</h2>
            <div class="acc-sub">${esc(fmt(v.created))} · ${esc(v.chamber)} ${v.billNum ? "· "+esc(v.billNum):""}</div>
          </div>
        </div>
        <div class="acc-badges">
          ${pill(v.result)}
          <span class="chip">Yeas ${v.yeas}</span>
          <span class="chip">Nays ${v.nays}</span>
          ${v.present ? `<span class="chip">Present ${v.present}</span>` : ``}
          ${v.notvoting ? `<span class="chip">Not Voting ${v.notvoting}</span>` : ``}
        </div>
      </summary>
      <div class="acc-wrap"><div class="acc-body">
        <section class="acc-sec"><div class="summary"><h3>Bill Summary</h3><p>${esc(v.summary || "—")}</p></div></section>
        <section class="acc-sec"><div class="meta-grid">
          <div class="meta"><div class="meta-label">Bill / Nomination</div><div>${v.billNum ? `<span class="chip">${esc(v.billNum)}</span>` : "—"}</div></div>
          <div class="meta"><div class="meta-label">Vote Type</div><div>${esc(v.voteType || "—")}</div></div>
          <div class="meta"><div class="meta-label">Required Threshold</div><div>${esc(v.required || "—")}</div></div>
          <div class="meta"><div class="meta-label">Roll #</div><div>${v.roll ? `<span class="chip">${esc(v.roll)}</span>` : "—"}</div></div>
        </div></section>
        <section class="acc-sec"><div class="meta"><div class="meta-label">Question / Motion</div><div>${esc(v.question || "—")}</div></div></section>
        <section class="acc-sec">${renderYN(v)}</section>
        <section class="acc-sec"><div class="meta-grid">
          <div class="meta"><div class="meta-label">Result</div><div>${pill(v.result)}</div></div>
          <div class="meta"><div class="meta-label">Chamber</div><div>${esc(v.chamber)}</div></div>
          <div class="meta"><div class="meta-label">Date & Time</div><div>${esc(fmtDT(v.created))}</div></div>
          <div class="meta"><div class="meta-label">Official Source</div><div>
            ${primary ? `<a class="btn" href="${esc(primary)}" target="_blank" rel="noopener">Source — .gov${v.billNum ? ` • ${esc(v.billNum)}` : ''}</a>` : '—'}
            ${v.link && !primary ? `<a class="btn" href="${esc(v.link)}" target="_blank" rel="noopener">Backup — GovTrack</a>` : ''}
            <button class="btn copy" data-url="${esc(primary || v.link || location.href)}">Copy link</button>
          </div></div>
        </div></section>
      </div></div>
    </details>`;
  }

  function ensureYear(y){
    let d = yearsEl.querySelector(`details.year[data-year="${y}"]`);
    if (!d){
      d = document.createElement('details');
      d.className = 'year'; d.dataset.year = y; if (y === now.getFullYear()) d.open = true;
      d.innerHTML = `<summary>${y}<span class="year-count" data-count="${y}"></span></summary><div class="year-body"></div>`;
      yearsEl.appendChild(d);
    }
    return d;
  }
  function ensureMonth(y, key, label){
    const year = ensureYear(y);
    const body = year.querySelector('.year-body');
    let m = body.querySelector(`details.month[data-month="${key}"]`);
    if (!m){
      m = document.createElement('details');
      m.className = 'month'; m.dataset.month = key;
      if (key === nowMonthKey && y === nowYear) m.open = true; // current month open
      m.innerHTML = `<summary>${label}</summary><div class="list" data-list="${key}"></div>`;
      body.appendChild(m);
    }
    return m.querySelector(`[data-list="${key}"]`);
  }
  function bumpYearCount(year, delta){
    const c = yearsEl.querySelector(`[data-count="${year}"]`);
    if (!c) return;
    const prev = parseInt(c.textContent || '0', 10) || 0;
    c.textContent = ` • ${prev + delta}`;
  }
  function monthKeyOf(d){
    const dt = D(d)||new Date();
    const y = dt.getFullYear();
    const m = dt.toLocaleDateString(undefined,{month:'long'});
    return {year:y, key:`${y}-${String(dt.getMonth()+1).padStart(2,'0')}`, label:m};
  }
  function renderItems(items){
    if (!items.length) return;
    const asc = (sortSel.value === 'created');
    items.sort((a,b)=> (asc ? (D(a.created)-D(b.created)) : (D(b.created)-D(a.created)) ));
    items.forEach(v=>{
      const mk = monthKeyOf(v.created);
      const list = ensureMonth(mk.year, mk.key, mk.label);
      list.insertAdjacentHTML('beforeend', card(v));
      bumpYearCount(mk.year, 1);
    });
    yearsEl.querySelectorAll('.copy').forEach(btn=>{
      if (btn.__wired) return; btn.__wired = true;
      btn.addEventListener('click', async e=>{
        e.stopPropagation();
        try{ await navigator.clipboard.writeText(btn.getAttribute('data-url') || location.href);
             btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy link',1200);}catch{}
      });
    });
    yearsEl.querySelectorAll('details.acc').forEach(d=>{
      if (d.__wired) return; d.__wired = true;
      const wrap = d.querySelector('.acc-wrap');
      const setH = ()=>{
        wrap.style.maxHeight = 'none';
        wrap.style.maxHeight = d.open ? wrap.scrollHeight+'px' : '0px';
      };
      setH(); d.addEventListener('toggle', setH);
      window.addEventListener('resize', ()=>{ if(d.open) setH(); });
    });
  }

  // ---------- fetching ----------
  function buildGovtrackQS(includeChamberParam=true){
    const p = new URLSearchParams();
    p.set('limit', String(LIMIT));
    p.set('offset', String(offset));
    p.set('order_by', sortSel.value);
    const ch = (chamberSel.value||'').toLowerCase();
    if (includeChamberParam && (ch==='house'||ch==='senate')) p.set('chamber', ch);
    const term = (q.value||"").trim(); if (term) p.set('q', term);
    return p.toString();
  }

  async function fetchGovTrack(){
    const qs = buildGovtrackQS(true);
    const url = `https://www.govtrack.us/api/v2/vote?${qs}`;
    debugNote.textContent = `govtrack: ${url}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) return [];
    const j = await r.json();
    return normalizeGovtrack(j?.objects||[]);
  }

  async function fetchHouseViaCongressGov(){
    // Prefer our proxy for House (returns already-normalized items).
    const params = new URLSearchParams();
    params.set('offset', String(offset));
    params.set('limit', String(LIMIT));
    const ch = (chamberSel.value||'').toLowerCase();
    // you can also pass congress/session explicitly via dropdowns later if desired
    const url = `/api/house/rollcalls?${params.toString()}`;
    debugNote.textContent = `congress.gov proxy: ${url}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) return [];
    const j = await r.json();
    return Array.isArray(j?.objects) ? j.objects : [];
  }

  async function loadPage({reset=false}={}){
    if (reset){
      yearsEl.innerHTML=''; offset=0; reachedEnd=false; emptyStreak=0;
      prevBtn.disabled = true; nextBtn.disabled=false; debugNote.textContent='';
    }
    if (reachedEnd){ nextBtn.disabled = true; return; }

    let items = [];
    const ch = (chamberSel.value||'').toLowerCase();

    if (ch === 'house'){
      // Try .gov first, then fallback to GovTrack silently
      items = await fetchHouseViaCongressGov();
      if (!items.length) items = await fetchGovTrack();
    } else {
      // Senate or All – GovTrack is fine; Senate still gets .gov links on open.
      items = await fetchGovTrack();
    }

    renderItems(items);

    const first = items[0]?.created, last = items[items.length-1]?.created;
    rangeNote.textContent = items.length
      ? `Loaded ${items.length}${first&&last ? ` (${fmt(first)} → ${fmt(last)})` : ''}`
      : `No votes on this slice — digging back…`;

    if (items.length>0){
      emptyStreak = 0; offset += LIMIT; nextBtn.disabled=false;
    } else {
      emptyStreak += 1; offset += LIMIT; nextBtn.disabled=false;
      if (emptyStreak >= 30){ reachedEnd=true; nextBtn.disabled=true; rangeNote.textContent=`No more results for these filters.`; }
    }
    pageNote.textContent = `Pages loaded: ${Math.floor(offset / LIMIT)}`;

    // Chamber deep-seek when empty
    const chPicked = (ch==='house' || ch==='senate');
    if (chPicked && items.length===0 && !reachedEnd){
      setTimeout(()=>loadPage({reset:false}), 0);
    }
  }

  q.addEventListener('input', ()=> loadPage({reset:true}));
  chamberSel.addEventListener('change', ()=> loadPage({reset:true}));
  resultSel.addEventListener('change', ()=> loadPage({reset:true}));
  sortSel.addEventListener('change', ()=> loadPage({reset:true}));
  clearBtn.addEventListener('click', ()=>{ q.value=""; chamberSel.value=""; resultSel.value=""; sortSel.value="-created"; loadPage({reset:true}); });
  prevBtn.addEventListener('click', ()=>{ /* optional newer */ });
  nextBtn.addEventListener('click', ()=> loadPage({reset:false}));

  (document.readyState==='loading')
    ? document.addEventListener('DOMContentLoaded', ()=>loadPage({reset:true}))
    : loadPage({reset:true});
})();
</script>
</body>
</html>
