<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Capitol League — Votes</title>
<style>
  :root{
    --bg:#0e1020;--panel:#171a2b;--panel2:#1d2140;--text:#e7e9f4;--muted:#9aa1bd;
    --accent:#6ea8fe;--border:1px solid rgba(255,255,255,.08);--radius:14px;--gap:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Inter,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px}
  /* Shared header */
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0e1020 70%,#0e102000)}
  .topbar{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;padding:12px 0;border-bottom:var(--border)}
  .navL,.navR{display:flex;gap:10px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;justify-self:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:var(--accent)}
  .brand h1{margin:0;font:600 16px/1.1 system-ui}
  .tab{padding:8px 12px;border:var(--border);border-radius:999px;background:transparent}
  .tab.active{background:var(--panel2);border-color:#2a2e52}
  .pill{font-size:12px;color:var(--muted);padding:4px 8px;border:var(--border);border-radius:999px;background:var(--panel2)}
  /* Page controls */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px 0}
  select,.input,.btn{background:var(--panel);border:var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
  .btn{background:var(--accent);border:none;color:#0d1020;cursor:pointer}
  /* Cards */
  main{padding:16px 0 28px}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
  @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:var(--border);border-radius:var(--radius);padding:14px}
  .head{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .title{font-weight:600}
  .sub{color:var(--muted);font-size:13px}
  details{background:var(--panel2);border:var(--border);border-radius:12px;margin-top:12px}
  summary{cursor:pointer;list-style:none;padding:12px 14px}
  summary::-webkit-details-marker{display:none}
  .rows{display:grid;border-top:var(--border)}
  .row{display:grid;grid-template-columns:1.2fr .6fr .6fr .6fr .6fr;gap:8px;padding:10px 14px;border-bottom:var(--border);font-size:14px}
  .row.head{color:var(--muted);background:#151935;font-weight:600}
  .kpi{display:flex;gap:8px}
  .kpi span{padding:4px 8px;border-radius:8px;background:#14183a;border:var(--border);font-size:12px}
  .tag-win{background:rgba(47,191,113,.12);border:1px solid rgba(47,191,113,.3);color:#8de0b4}
  .tag-lose{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.3);color:#ffb3b3}
  .empty{padding:30px;text-align:center;color:var(--muted);border:var(--border);border-radius:12px;background:#12142a}
  .footer{margin-top:18px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <nav class="navL">
      <a class="tab" href="index.html">Scoreboard</a>
      <a class="tab" href="draft.html">draft</a>
      <a class="tab active" href="votes.html">Votes</a>
    </nav>
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <h1>Capitol League</h1>
    </div>
    <nav class="navR">
      <a class="tab" href="cards.html">Cards</a>
      <a class="tab" href="rules.html">Rules</a>
    </nav>
  </div>
  <div class="wrap">
    <div class="controls">
      <span class="pill">House</span>
      <select id="congressSel">
        <option value="119">119th (2025–2026)</option>
        <option value="118">118th (2023–2024)</option>
      </select>
      <select id="sessionSel">
        <option value="1">1st session</option>
        <option value="2">2nd session</option>
      </select>
      <input id="q" class="input" placeholder="Filter text… (bill, question)"/>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="list" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No votes found.</div>
  <div class="footer" id="foot"></div>
</main>

<script>
const API_KEY = "KOURntCmZiIclaOlArU3lZJrkSasn58VS3vZpuam";
const BASE = "https://api.congress.gov/v3";

function listHouseVotes({ congress, session, limit=40, offset=0 }) {
  const url = `${BASE}/house-roll-call-votes?congress=${congress}&sessionNumber=${session}&limit=${limit}&offset=${offset}&api_key=${API_KEY}&format=json`;
  return fetchJSON(url);
}
function getHouseVoteMembers({ congress, session, roll, limit=500, offset=0 }) {
  const url = `${BASE}/house-roll-call-votes/${congress}/${session}/${roll}/member-votes?limit=${limit}&offset=${offset}&api_key=${API_KEY}&format=json`;
  return fetchJSON(url);
}
async function fetchJSON(url){
  const res = await fetch(url);
  if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
  return res.json();
}

const $list=document.getElementById("list");
const $empty=document.getElementById("empty");
const $foot=document.getElementById("foot");
const $q=document.getElementById("q");
const $congress=document.getElementById("congressSel");
const $session=document.getElementById("sessionSel");
const $refresh=document.getElementById("refreshBtn");

let state={ congress:$congress.value, session:$session.value, votes:[], lastFetched:null };

$congress.onchange=()=>{ state.congress=$congress.value; loadVotes(); };
$session.onchange=()=>{ state.session=$session.value; loadVotes(); };
$refresh.onclick=()=> loadVotes();
$q.oninput=()=> render();

async function loadVotes(){
  $list.innerHTML=""; $empty.style.display="none"; $foot.textContent="Loading…";
  try{
    const data=await listHouseVotes({ congress:state.congress, session:state.session, limit:40, offset:0 });
    const coll=data?.houseRollCallVotes?.items || data?.items || [];
    state.votes=coll.map(normalizeListItem);
    state.lastFetched=new Date();
    render();
    const total=data?.pagination?.count ?? state.votes.length;
    $foot.textContent=`Showing ${state.votes.length} of ${total} — Congress ${state.congress}, Session ${state.session}.`;
  }catch(err){
    $list.innerHTML="";
    $empty.style.display="block";
    $empty.textContent="Failed to load votes. Verify API key and endpoint path.";
    $foot.textContent=String(err.message||err);
  }
}

function normalizeListItem(it){
  return {
    roll: it.rollNumber ?? it.roll ?? "?",
    date: it.voteDate ?? it.date ?? "",
    question: it.voteQuestionText ?? it.voteQuestion ?? "",
    result: it.resultText ?? it.result ?? "",
    bill: it.billNumber ?? it.bill ?? it.measureNumber ?? "",
    description: it.description ?? it.voteDescription ?? "",
    link: it.url ?? it.link ?? "",
    totals:{
      yea: it.yeaTotal ?? it.yeas ?? 0,
      nay: it.nayTotal ?? it.nays ?? 0,
      present: it.presentTotal ?? it.present ?? 0,
      notvoting: it.notVotingTotal ?? it.notVoting ?? 0
    }
  };
}

function render(){
  const n=$q.value.trim().toLowerCase();
  const items=state.votes.filter(v=>{
    if(!n) return true;
    return [v.bill,v.question,v.description,v.result].some(s=>String(s||"").toLowerCase().includes(n));
  });
  if(items.length===0){ $list.innerHTML=""; $empty.style.display="block"; $empty.textContent="No votes match your filter."; return; }
  $empty.style.display="none";
  $list.innerHTML=items.map(cardHTML).join("");
  attachMemberHandlers();
}

function cardHTML(v){
  const ok=/agree|passed|agreed/i.test(v.result);
  return `
  <article class="card">
    <div class="head">
      <span class="pill">Roll ${v.roll}</span>
      <div>
        <div class="title">${escapeHTML(v.question||"Vote")}</div>
        <div class="sub">${escapeHTML(v.bill||"—")} • ${escapeHTML(v.date||"")}</div>
      </div>
      <div class="kpi">
        <span class="${ok?'tag-win':'tag-lose'}">${escapeHTML(v.result||"Result")}</span>
      </div>
    </div>
    <details>
      <summary>Details</summary>
      <div class="rows">
        <div class="row head"><div>Description</div><div>Yea</div><div>Nay</div><div>Present</div><div>Not voting</div></div>
        <div class="row">
          <div>${escapeHTML(v.description||"—")}</div>
          <div>${v.totals.yea??"—"}</div>
          <div>${v.totals.nay??"—"}</div>
          <div>${v.totals.present??"—"}</div>
          <div>${v.totals.notvoting??"—"}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;padding:12px 14px;">
        <button class="btn btn-members" data-roll="${v.roll}">Member votes</button>
        ${v.link?`<a class="tab" href="${v.link}" target="_blank" rel="noopener">Open on Congress.gov</a>`:""}
      </div>
      <div class="memberMount" id="m-${v.roll}" style="padding:0 14px 14px;"></div>
    </details>
  </article>`;
}

function attachMemberHandlers(){
  document.querySelectorAll(".btn-members").forEach(btn=>{
    btn.onclick=async()=>{
      const roll=btn.dataset.roll;
      const mount=document.getElementById(`m-${roll}`);
      if(!mount) return;
      btn.disabled=true; btn.textContent="Loading…";
      try{
        const data=await getHouseVoteMembers({ congress:state.congress, session:state.session, roll });
        const rows=(data?.memberVotes?.items || data?.items || []).map(n=>({
          name:n?.member?.name ?? n?.name ?? "Member",
          party:n?.member?.party ?? n?.party ?? "—",
          state:n?.member?.state ?? n?.state ?? "—",
          vote:n?.position ?? n?.vote ?? "—"
        }));
        mount.innerHTML=memberTableHTML(rows);
      }catch(e){
        mount.innerHTML=`<div class="sub" style="color:#ffb3b3">Failed to load member votes.</div>`;
      }finally{
        btn.disabled=false; btn.textContent="Member votes";
      }
    };
  });
}

function memberTableHTML(rows){
  if(rows.length===0) return `<div class="sub">No member data.</div>`;
  const head=`<div class="row head"><div>Member</div><div>Party</div><div>State</div><div style="grid-column:span 2;">Position</div></div>`;
  const body=rows.map(r=>`
    <div class="row">
      <div>${escapeHTML(r.name)}</div>
      <div>${escapeHTML(r.party)}</div>
      <div>${escapeHTML(r.state)}</div>
      <div style="grid-column:span 2;">${escapeHTML(r.vote)}</div>
    </div>`).join("");
  return `<div class="rows" style="margin-top:8px">${head}${body}</div>`;
}

function escapeHTML(s){return String(s??"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));}
loadVotes();
</script>
</body>
</html>
