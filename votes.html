<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Capitol League — Votes</title>
<style>
  :root{
    --bg:#0e1020; --panel:#171a2b; --panel2:#1d2140; --text:#e7e9f4; --muted:#9aa1bd;
    --accent:#6ea8fe; --good:#2fbf71; --bad:#ff6b6b; --warn:#f7b500; --radius:14px; --gap:14px;
    --border:1px solid rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Inter,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:linear-gradient(180deg,#0e1020 60%,#0e102000);z-index:10}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0 14px;border-bottom:var(--border)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:34px;height:34px;border-radius:10px;background:var(--accent);display:inline-block}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:var(--border);border-radius:999px;background:transparent;cursor:pointer}
  .tab.active{background:var(--panel2);border-color:#2a2e52}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .input, select{background:var(--panel);border:var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
  .btn{background:var(--accent);border:none;color:#0d1020;padding:10px 14px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-top:16px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--panel);border:var(--border);border-radius:var(--radius);padding:14px}
  .head{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .pill{font-size:12px;color:var(--muted);padding:4px 8px;border:var(--border);border-radius:999px;background:var(--panel2)}
  .title{font-weight:600}
  .sub{color:var(--muted);font-size:13px}
  details{background:var(--panel2);border:var(--border);border-radius:12px;margin-top:12px}
  summary{cursor:pointer;list-style:none;padding:12px 14px}
  summary::-webkit-details-marker{display:none}
  .rows{display:grid;border-top:var(--border)}
  .row{display:grid;grid-template-columns:1.2fr .6fr .6fr .6fr .6fr;gap:8px;padding:10px 14px;border-bottom:var(--border);font-size:14px}
  .row.head{color:var(--muted);background:#151935;font-weight:600}
  .kpi{display:flex;gap:8px}
  .kpi span{padding:4px 8px;border-radius:8px;background:#14183a;border:var(--border);font-size:12px}
  .tag-win{background:rgba(47,191,113,.12);border:1px solid rgba(47,191,113,.3);color:#8de0b4}
  .tag-lose{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.3);color:#ffb3b3}
  .footer{margin-top:18px;color:var(--muted);font-size:12px}
  .empty{padding:30px;text-align:center;color:var(--muted);border:var(--border);border-radius:12px;background:#12142a}
</style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand">
        <span class="logo"></span>
        <div>
          <div style="font-weight:700">Capitol League</div>
          <div class="sub">Votes</div>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" data-chamber="house">House</button>
        <button class="tab" data-chamber="senate" disabled title="Congress.gov votes API is House-only for now">Senate</button>
      </div>
      <div class="controls">
        <select id="congressSel">
          <option value="119">119th (2025-2026)</option>
          <option value="118">118th (2023-2024)</option>
        </select>
        <select id="sessionSel">
          <option value="1">1st session</option>
          <option value="2">2nd session</option>
        </select>
        <input id="q" class="input" placeholder="Filter text… (bill, question)" />
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No votes found.</div>
    <div class="footer" id="foot"></div>
  </main>

<script>
/*
  Configure your Congress.gov API key.
  Docs + change log: https://api.congress.gov/  (served via api.data.gov)
  House Roll Call Votes endpoints (beta) launched May 13, 2025.
  You will likely use list -> item -> member-votes endpoints.
  Blog announcement: https://blogs.loc.gov/law/2025/05/introducing-house-roll-call-votes-in-the-congress-gov-api/
*/
const API_KEY = "KOURntCmZiIclaOlArU3lZJrkSasn58VS3vZpuam"; // <- required

// Endpoint builders. Adjust paths if Congress.gov updates naming.
const BASE = "https://api.congress.gov/v3";

// List votes associated with legislation (House, 118th+). Supports pagination via offset.
function listHouseVotes({ congress, session, limit=40, offset=0 }) {
  // Known pattern in v3: collection path segments, query keys follow camelCase in many endpoints.
  // If this 404s in your environment, change the path below to whatever the docs specify today.
  const url = `${BASE}/house-roll-call-votes?congress=${congress}&sessionNumber=${session}&limit=${limit}&offset=${offset}&api_key=${API_KEY}&format=json`;
  return fetchJSON(url);
}

// Item details by roll number.
function getHouseVote({ congress, session, roll }) {
  const url = `${BASE}/house-roll-call-votes/${congress}/${session}/${roll}?api_key=${API_KEY}&format=json`;
  return fetchJSON(url);
}

// Member-level positions for a roll. Returns BioGuide IDs and positions.
function getHouseVoteMembers({ congress, session, roll, limit=500, offset=0 }) {
  const url = `${BASE}/house-roll-call-votes/${congress}/${session}/${roll}/member-votes?limit=${limit}&offset=${offset}&api_key=${API_KEY}&format=json`;
  return fetchJSON(url);
}

// Generic fetch with readable errors.
async function fetchJSON(url){
  const res = await fetch(url);
  if(!res.ok){
    const text = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status}: ${text.slice(0,160)}`);
  }
  return res.json();
}

// UI wiring
const $list = document.getElementById("list");
const $empty = document.getElementById("empty");
const $foot = document.getElementById("foot");
const $q = document.getElementById("q");
const $congress = document.getElementById("congressSel");
const $session = document.getElementById("sessionSel");
const $refresh = document.getElementById("refreshBtn");
const $tabs = document.querySelectorAll(".tab");

let state = {
  chamber: "house",
  congress: $congress.value,
  session: $session.value,
  votes: [],
  lastFetched: null
};

$tabs.forEach(b=>b.addEventListener("click", ()=>{
  if(b.disabled) return;
  $tabs.forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  state.chamber = b.dataset.chamber;
  loadVotes();
}));

$congress.addEventListener("change", ()=>{ state.congress = $congress.value; loadVotes(); });
$session.addEventListener("change", ()=>{ state.session = $session.value; loadVotes(); });
$refresh.addEventListener("click", ()=> loadVotes() );
$q.addEventListener("input", ()=> render());

async function loadVotes(){
  $list.innerHTML = "";
  $empty.style.display = "none";
  $foot.textContent = "Loading…";
  try{
    if(state.chamber !== "house") {
      $empty.style.display = "block";
      $empty.textContent = "Senate feed not available from this API yet.";
      $foot.textContent = "Source: Congress.gov API (House only for votes, 118th+).";
      return;
    }
    // Pull first page only to keep it fast; you can add pagination if needed.
    const data = await listHouseVotes({ congress: state.congress, session: state.session, limit: 40, offset: 0 });

    // Congress.gov v3 responses are shaped as { pagination, houseRollCallVotes: { ...items } }.
    // Normalize defensively in case of schema tweaks.
    const coll = data?.houseRollCallVotes?.items || data?.items || [];
    state.votes = coll.map(normalizeListItem);
    state.lastFetched = new Date();
    render();
    const total = data?.pagination?.count ?? state.votes.length;
    $foot.textContent = `Showing ${state.votes.length} of ${total} — Congress ${state.congress}, Session ${state.session}.`;
  }catch(err){
    console.error(err);
    $list.innerHTML = "";
    $empty.style.display = "block";
    $empty.textContent = "Failed to load votes. Check API key and endpoint path in the JS header.";
    $foot.textContent = String(err.message || err);
  }
}

function normalizeListItem(it){
  // Try common fields; fall back gracefully.
  return {
    roll: it.rollNumber ?? it.roll ?? "?",
    date: it.voteDate ?? it.date ?? "",
    question: it.voteQuestionText ?? it.voteQuestion ?? "",
    result: it.resultText ?? it.result ?? "",
    bill: it.billNumber ?? it.bill ?? it.measureNumber ?? "",
    description: it.description ?? it.voteDescription ?? "",
    link: it.url ?? it.link ?? "",
    totals: {
      yea: it.yeaTotal ?? it.yeas ?? it.totalYes ?? 0,
      nay: it.nayTotal ?? it.nays ?? it.totalNo ?? 0,
      present: it.presentTotal ?? it.present ?? 0,
      notvoting: it.notVotingTotal ?? it.notVoting ?? 0
    }
  };
}

function render(){
  const needle = $q.value.trim().toLowerCase();
  const items = state.votes.filter(v=>{
    if(!needle) return true;
    return [v.bill, v.question, v.description, v.result].some(s=> String(s||"").toLowerCase().includes(needle));
  });
  if(items.length===0){
    $list.innerHTML = "";
    $empty.style.display = "block";
    $empty.textContent = "No votes match your filter.";
    return;
  }
  $empty.style.display = "none";
  $list.innerHTML = items.map(cardHTML).join("");
  attachExpandHandlers();
}

function cardHTML(v){
  const outcomeOK = /agree|passed|agreed/i.test(v.result);
  return `
  <article class="card">
    <div class="head">
      <span class="pill">Roll ${v.roll}</span>
      <div>
        <div class="title">${escapeHTML(v.question || "Vote")}</div>
        <div class="sub">${escapeHTML(v.bill || "—")} • ${escapeHTML(v.date || "")}</div>
      </div>
      <div class="kpi">
        <span class="${outcomeOK?'tag-win':'tag-lose'}">${escapeHTML(v.result || "Result")}</span>
      </div>
    </div>

    <details>
      <summary>Details</summary>
      <div class="rows">
        <div class="row head"><div>Description</div><div>Yea</div><div>Nay</div><div>Present</div><div>Not voting</div></div>
        <div class="row">
          <div>${escapeHTML(v.description || "—")}</div>
          <div>${v.totals.yea ?? "—"}</div>
          <div>${v.totals.nay ?? "—"}</div>
          <div>${v.totals.present ?? "—"}</div>
          <div>${v.totals.notvoting ?? "—"}</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;padding:12px 14px;">
        <button class="btn btn-members" data-roll="${v.roll}">Member votes</button>
        ${v.link ? `<a class="tab" href="${v.link}" target="_blank" rel="noopener">Open on Congress.gov</a>` : ""}
      </div>
      <div class="memberMount" id="m-${v.roll}" style="padding:0 14px 14px;"></div>
    </details>
  </article>`;
}

function attachExpandHandlers(){
  document.querySelectorAll(".btn-members").forEach(btn=>{
    btn.onclick = async ()=>{
      const roll = btn.dataset.roll;
      const mount = document.getElementById(`m-${roll}`);
      if(!mount) return;
      btn.disabled = true; btn.textContent = "Loading…";
      try{
        const data = await getHouseVoteMembers({ congress: state.congress, session: state.session, roll });
        const members = (data?.memberVotes?.items || data?.items || []).map(n=>{
          return {
            name: n?.member?.name ?? n?.name ?? "Member",
            party: n?.member?.party ?? n?.party ?? "—",
            state: n?.member?.state ?? n?.state ?? "—",
            vote: n?.position ?? n?.vote ?? "—"
          };
        });
        mount.innerHTML = memberTableHTML(members);
      }catch(err){
        mount.innerHTML = `<div class="sub" style="color:#ffb3b3">Failed to load member votes. Verify /member-votes endpoint path.</div>`;
      }finally{
        btn.disabled = false; btn.textContent = "Member votes";
      }
    };
  });
}

function memberTableHTML(rows){
  if(rows.length===0) return `<div class="sub">No member data.</div>`;
  const head = `<div class="row head"><div>Member</div><div>Party</div><div>State</div><div style="grid-column: span 2;">Position</div></div>`;
  const body = rows.map(r=>`
    <div class="row">
      <div>${escapeHTML(r.name)}</div>
      <div>${escapeHTML(r.party)}</div>
      <div>${escapeHTML(r.state)}</div>
      <div style="grid-column: span 2;">${escapeHTML(r.vote)}</div>
    </div>`).join("");
  return `<div class="rows" style="margin-top:8px">${head}${body}</div>`;
}

function escapeHTML(s){ return String(s??"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

// Kick off
loadVotes();
</script>
</body>
</html>
