<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Capitol League â€” Cards</title>
<style>
  :root{
    --nav-h: 64px;
    --panel:#0e1222; --panel-2:#151a2c;
    --text:#e7e9f4; --muted:#9aa1bd;
    --border:1px solid rgba(255,255,255,.06);
    --shadow:0 8px 24px rgba(0,0,0,.25);

    --card-w:320px; --card-h:448px; --thumb-scale:.82;
    --radius:14px;

    --brand:#6ea8fe; --pill:#1c2238; --pill-b:#2b3352; --pill-on:#6ea8fe; --pill-on-t:#0b1020;
  }

  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0e1a,#0f1220);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* ---------- Top nav (responsive, no clipping) ---------- */
  .topnav{position:sticky;top:0;left:0;right:0;background:rgba(16,19,36,.95);backdrop-filter:blur(10px);border-bottom:var(--border);z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.35)}
  .topnav__inner{
    max-width:1280px;margin:0 auto;padding:10px 16px;
    display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;min-height:var(--nav-h);
  }
  /* allow wrap on small screens */
  @media (max-width: 960px){
    .topnav__inner{grid-template-columns:1fr;gap:8px}
    .brand{justify-self:start}
    .seg-row{justify-content:flex-start}
  }

  .seg-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0}
  .field{display:flex;align-items:center;min-width:220px}
  .input{appearance:none;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:#e7e9f4;padding:10px 12px;border-radius:12px;font:600 14px/1 system-ui;width:100%}
  .input::placeholder{color:#9aa1bd}

  .pill{appearance:none;border:1px solid var(--pill-b);background:var(--pill);color:#c9cee6;border-radius:999px;padding:10px 14px;font:800 13px/1 system-ui;cursor:pointer;white-space:nowrap}
  .pill:hover{border-color:#3a446d}
  .pill.active{background:var(--pill-on);color:var(--pill-on-t);border-color:var(--pill-on)}
  .brand{justify-self:center;font-weight:900;letter-spacing:.4px;color:var(--text)}
  .brand span{color:var(--brand)}

  /* ---------- Layout ---------- */
  .app{padding-top:var(--nav-h)}
  .main{max-width:1280px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(calc(var(--card-w)*var(--thumb-scale) + 24px), 1fr));gap:16px}

  /* ---------- Card (flip) ---------- */
  .thumb{background:#0f142e;border:var(--border);border-radius:14px;box-shadow:var(--shadow);padding:10px;display:grid;place-items:center;cursor:pointer}
  .scale-wrap{width:calc(var(--card-w)*var(--thumb-scale));height:calc(var(--card-h)*var(--thumb-scale));overflow:hidden;position:relative;perspective:1200px}
  .card{width:var(--card-w);height:var(--card-h);transform:scale(var(--thumb-scale));transform-origin:top left;position:absolute;top:0;left:0}
  .flip{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .6s}
  .thumb:hover .flip,.thumb.flipped .flip{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:18px;background:#f5f6fb;box-shadow:0 12px 30px rgba(0,0,0,.35);border:6px solid #fff;overflow:hidden;backface-visibility:hidden}
  .front{display:grid;grid-template-rows:52px 1fr 88px}
  .back{transform:rotateY(180deg);background:#F3E5C3;border:6px solid #fff;color:#1C1F2B;display:grid;grid-template-rows:52px 1fr}
  .header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#fff;border-bottom:1px solid #e7e8f2;color:#0f1220}
  .back .header{background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));border-bottom:1px solid rgba(0,0,0,.06);color:#2A2E45}
  .chip{background:#1f4aa8;color:#fff;font-weight:800;letter-spacing:.4px;padding:6px 10px;border-radius:999px;font-size:12px}
  .photo{position:relative;margin:10px;border-radius:12px;overflow:hidden;height:calc(var(--card-h) - 52px - 88px - 20px);background:#0c1026;display:grid;place-items:center}
  .photo img{width:100%;height:100%;object-fit:cover}
  .photo::after{content:"";position:absolute;inset:0;box-shadow:inset 0 -80px 120px rgba(0,0,0,.45)}
  .footer{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;padding:10px;background:#fff;border-top:1px solid #e7e8f2;color:#0f1220}
  .name{font-weight:900;font-size:20px;letter-spacing:.3px;color:#0f1220;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-weight:700;color:#6b7390;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{background:#0f6f3d;color:#dcffe7;font-weight:800;font-size:12px;border-radius:10px;padding:6px 10px}

  .accent{position:absolute;right:-6px;top:0;height:72px;width:140px;background:linear-gradient(180deg,#1f4aa8,#c71f2d);clip-path:polygon(0 0,100% 0,100% 100%,18% 100%);display:grid;align-items:center;justify-items:end;padding-right:10px;color:#fff;font-weight:900;font-size:18px}
  .accent span{transform:translateY(-4px)}
  .badge-chip{position:absolute;left:10px;top:10px;border-radius:999px;padding:6px 10px;font-weight:900;font-size:11px;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .badge-iron{background:#125c2c}.badge-wild{background:#6b1ab4}.badge-rookie{background:#b4551a}

  .stats{padding:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr;overflow:auto}
  .stat.kpis{grid-column:1 / -1;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi{background:#fff;border:1px solid #E3CFA2;border-radius:10px;padding:10px;text-align:center}
  .kpi strong{display:block;color:#2A2E45;font-size:11px;margin-bottom:4px}
  .kpi .v{font-weight:900;font-size:18px}
  .stat{background:#fff;border:1px solid #E3CFA2;border-radius:10px;padding:10px;font-size:12px;color:#1C1F2B}
  .stat strong{display:block;color:#2A2E45;margin-bottom:4px}
</style>
</head>
<body>
  <!-- Top Navigation -->
  <header class="topnav">
    <div class="topnav__inner">
      <!-- Left controls -->
      <div class="seg-row" id="leftControls">
        <div class="field"><input id="searchInput" class="input" type="search" placeholder="Search name" autocomplete="off" /></div>
        <button class="pill" data-state="all" id="stateAllBtn">All States</button>
        <button class="pill active" data-chamber="all">All</button>
        <button class="pill" data-chamber="senate">Senate</button>
        <button class="pill" data-chamber="house">House</button>
      </div>

      <!-- Brand (center) -->
      <div class="brand">Capitol <span>League</span></div>

      <!-- Right controls -->
      <div class="seg-row" id="rightControls">
        <button class="pill active" data-party="all">All</button>
        <button class="pill" data-party="Dem">Dem</button>
        <button class="pill" data-party="Rep">Rep</button>
        <button class="pill" data-party="Ind">Ind</button>

        <button class="pill active" data-badge="all">All Badges</button>
        <button class="pill" data-badge="iron">Ironman</button>
        <button class="pill" data-badge="rookie">Rookie</button>
        <button class="pill" data-badge="wild">Wild Card</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div id="cardGrid" class="grid" aria-live="polite"></div>
  </main>

<script>
(function(){
  'use strict';

  /* ----------------- State ----------------- */
  const grid = document.getElementById('cardGrid');
  let chamberFilter = 'all';
  let partyFilter   = 'all';
  let badgeFilter   = 'all';
  let searchQuery   = '';
  let stateFilter   = 'all';

  let membersAll = [];
  const DATA_URL = 'https://unitedstates.github.io/congress-legislators/legislators-current.json';
  const params = new URLSearchParams(location.search);
  const KPI_URL = params.get('kpi') || (location.origin + location.pathname.replace(/\/[^\/]*$/,'') + '/dist/kpis.csv');

  /* ----------------- Utils ----------------- */
  const IMG = (bioguide) => 'https://unitedstates.github.io/images/congress/225x275/' + bioguide + '.jpg';
  const SNAME = (code)=>({AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia"})[code]||code;

  function partyLabel(p){
    if(!p) return '';
    if(/^Dem/i.test(p)) return 'DEMOCRAT';
    if(/^Rep/i.test(p)) return 'REPUBLICAN';
    if(/^Ind/i.test(p)) return 'INDEPENDENT';
    return p.toUpperCase();
  }

  function computeBadge(m){
    const y = parseInt((m.start||'').slice(0,4),10) || 0;
    if(/^Ind/i.test(m.party)) return {label:'Wild Card', cls:'badge-wild', key:'wild'};
    if(y && y<=2015) return {label:'Ironman', cls:'badge-iron', key:'iron'};
    if(y>=2023) return {label:'Rookie', cls:'badge-rookie', key:'rookie'};
    return null;
  }

  /* ----------------- KPI support ----------------- */
  const kpiMap = Object.create(null);
  const kpiReady = fetch(KPI_URL, {cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('KPI fetch failed'); return r.text(); })
    .then(text=>{
      // expect CSV: govtrack,total_votes,missed_votes
      const lines = text.trim().split(/\r?\n/);
      const header = (lines.shift()||'').split(',').map(s=>s.trim());
      const gi = header.indexOf('govtrack'), ti = header.indexOf('total_votes'), mi = header.indexOf('missed_votes');
      lines.forEach(line=>{
        const parts = line.split(','); if(!parts.length) return;
        const id = String(parts[gi]||'').trim();
        const t  = +((parts[ti]||'').trim() || 0);
        const m  = +((parts[mi]||'').trim() || 0);
        if(id) kpiMap[id] = { total_votes:t, missed_votes:m };
      });
    })
    .catch(()=>{ /* leave empty map; cards will show N/A */ });

  function kpiFromCounts(total, missed){
    const t = +total||0, m = +missed||0, cast = Math.max(0, t-m);
    return {voted:cast, missedVotes:m, votePct: t? (cast/t*100):0, missPct: t? (m/t*100):0};
  }

  function fetchKPI(govtrackId){
    if(!govtrackId) return Promise.resolve(null);
    return kpiReady.then(()=>{
      const e = kpiMap[String(govtrackId)];
      return e ? kpiFromCounts(e.total_votes, e.missed_votes) : null;
    });
  }

  function applyKPIs(card, k){
    const q = (s)=> card.querySelector('[data-kpi="'+s+'"]');
    if(!k){
      ['votes','misses','votePct','missPct'].forEach(s=>{ const el=q(s); if(el) el.textContent='N/A';});
      return;
    }
    const elV=q('votes'), elM=q('misses'), elVP=q('votePct'), elMP=q('missPct');
    if(elV) elV.textContent=(k.voted||0).toLocaleString();
    if(elM) elM.textContent=(k.missedVotes||0).toLocaleString();
    if(elVP) elVP.textContent=(k.votePct||0).toFixed(1)+'%';
    if(elMP) elMP.textContent=(k.missPct||0).toFixed(1)+'%';
  }

  function ensureKPIsForCard(card){
    const id = card && card.dataset.govtrack;
    if(!id){ applyKPIs(card,null); return; }
    fetchKPI(id).then(k=> applyKPIs(card,k));
  }

  /* ----------------- Card ----------------- */
  function cardEl(m){
    const art = document.createElement('article');
    art.className = 'thumb';
    art.tabIndex = 0;
    art.setAttribute('role','button');
    art.dataset.name = m.name;
    art.dataset.govtrack = m.govtrack||'';
    art.dataset.bioguide = m.bioguide||'';

    const badge = computeBadge(m);
    const badgeHTML = badge ? `<div class="badge-chip ${badge.cls}" title="${badge.label}">${badge.label}</div>` : '';
    const startYear = m.careerStart?m.careerStart.slice(0,4):'';

    art.innerHTML = `
      <div class="scale-wrap"><div class="card"><div class="flip">
        <section class="face front">
          <div class="accent"><span>${m.state}</span></div>
          ${badgeHTML}
          <header class="header"><div></div><div class="chip">${partyLabel(m.party)}</div></header>
          <div class="photo">${m.photo?(`<img alt="Portrait of ${m.name.replace(/"/g,'&quot;')}" src="${m.photo}" onerror="this.remove()">`):''}</div>
          <footer class="footer">
            <div>
              <div class="name">${m.name.toUpperCase()}</div>
              <div class="meta">${SNAME(m.state)} â€¢ Since ${startYear||''}</div>
            </div>
            <div class="badge" data-score-el>+0 pts</div>
          </footer>
        </section>

        <section class="face back">
          <header class="header"><div>Career Stats</div><div class="chip">${m.state}</div></header>
          <div class="stats">
            <div class="stat"><strong>Party</strong> ${m.party}</div>
            <div class="stat"><strong>Chamber</strong> ${m.chamber}</div>
            <div class="stat"><strong>Term</strong> ${m.start||''} â†’ ${m.end||''}</div>
            <div class="stat"><strong>Bioguide</strong> ${m.bioguide||''}</div>
            <div class="stat"><strong>GovTrack</strong> ${m.govtrack||''}</div>
            <div class="stat kpis">
              <div class="kpi"><strong>Career Votes</strong><div class="v" data-kpi="votes">N/A</div></div>
              <div class="kpi"><strong>Misses</strong><div class="v" data-kpi="misses">N/A</div></div>
              <div class="kpi"><strong>Vote %</strong><div class="v" data-kpi="votePct">N/A</div></div>
              <div class="kpi"><strong>Miss %</strong><div class="v" data-kpi="missPct">N/A</div></div>
            </div>
          </div>
        </section>
      </div></div></div>
    `;

    // flip interaction (kept, but not required for KPI load)
    art.addEventListener('click', ()=>{
      art.classList.toggle('flipped');
      if(art.classList.contains('flipped')) ensureKPIsForCard(art);
    });
    art.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'||e.key===' '){ e.preventDefault(); art.classList.toggle('flipped'); if(art.classList.contains('flipped')) ensureKPIsForCard(art); }
    });

    // Lazy KPI load when card comes into view (first time)
    if('IntersectionObserver' in window){
      const io = new IntersectionObserver((entries, obs)=>{
        entries.forEach(en=>{
          if(en.isIntersecting){ ensureKPIsForCard(art); obs.unobserve(art); }
        });
      }, {root:null, rootMargin:'200px'});
      io.observe(art);
    } else {
      // fallback: load immediately
      ensureKPIsForCard(art);
    }

    return art;
  }

  function render(list){
    grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    list.forEach(m=> frag.appendChild(cardEl(m)));
    grid.appendChild(frag);
  }

  function applyFilters(){
    const q = searchQuery.trim().toLowerCase();
    const out = membersAll.filter(m=>{
      const okC = (chamberFilter==='all') || (chamberFilter==='senate' && m.chamber==='Senate') || (chamberFilter==='house' && m.chamber==='House');
      const okP = (partyFilter==='all') || (partyFilter==='Dem' && /^Dem/i.test(m.party||'')) || (partyFilter==='Rep' && /^Rep/i.test(m.party||'')) || (partyFilter==='Ind' && /^Ind/i.test(m.party||''));
      const okS = (stateFilter==='all') || (m.state===stateFilter);
      let okB = true; if(badgeFilter!=='all'){ const b = computeBadge(m); okB = !!b && b.key===badgeFilter; }
      const okQ = !q || (m.name && m.name.toLowerCase().includes(q));
      return okC && okP && okS && okB && okQ;
    });
    render(out);
  }

  /* ----------------- Initial load ----------------- */
  fetch(DATA_URL, {cache:'no-store'})
    .then(r=>r.json())
    .then(list=>{
      const members = list.map(r=>{
        const id=r.id||{}, name=r.name||{}, terms=r.terms||[], first=terms[0]||{}, last=terms[terms.length-1]||{};
        const chamber = last.type==='sen'?'Senate':(last.type==='rep'?'House':'');
        return {
          bioguide:id.bioguide,
          govtrack:id.govtrack,
          name:(name.official_full||((name.first||'')+' '+(name.last||''))).trim(),
          state:last.state||'',
          party:last.party||'',
          chamber,
          start:last.start,
          careerStart:first.start,
          end:last.end,
          photo:id.bioguide?IMG(id.bioguide):''
        };
      }).filter(m=> m.chamber && m.end && new Date(m.end)>new Date());
      membersAll = members;
      applyFilters();
    })
    .catch(()=>{ grid.innerHTML='<div style="opacity:.7">Failed to load roster.</div>'; });

  /* ----------------- Controls ----------------- */
  const left = document.getElementById('leftControls');
  const right= document.getElementById('rightControls');
  const searchInput = document.getElementById('searchInput');

  // Chamber pills
  left.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-chamber]'); if(!b) return;
    chamberFilter = b.dataset.chamber;
    left.querySelectorAll('[data-chamber]').forEach(x=> x.classList.toggle('active', x===b));
    applyFilters();
  });

  // "All States" pill just clears state filter for now (kept for parity)
  document.getElementById('stateAllBtn').addEventListener('click', function(){
    stateFilter = 'all';
    this.classList.add('active');
    applyFilters();
  });

  // Party pills
  right.addEventListener('click', (e)=>{
    const bp = e.target.closest('[data-party]');
    const bb = e.target.closest('[data-badge]');
    if(bp){
      partyFilter = bp.dataset.party;
      right.querySelectorAll('[data-party]').forEach(x=> x.classList.toggle('active', x===bp));
      applyFilters();
    } else if(bb){
      badgeFilter = bb.dataset.badge;
      right.querySelectorAll('[data-badge]').forEach(x=> x.classList.toggle('active', x===bb));
      applyFilters();
    }
  });

  // Search
  searchInput.addEventListener('input', ()=>{ searchQuery = searchInput.value||''; applyFilters(); });

})();
</script>
</body>
</html>
