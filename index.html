<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Capitol League — Cards</title>
  <style>
    :root{
      --nav-h:64px; --panel:#171a2b; --panel-2:#1d2140; --text:#e7e9f4; --muted:#9aa1bd;
      --border:1px solid rgba(255,255,255,.06); --shadow:0 8px 24px rgba(0,0,0,.25);
      --card-w:320px; --card-h:448px; --thumb-scale:.82; --radius:14px;
      --back-paper:#F3E5C3; --back-ink:#1C1F2B; --back-ink-2:#2A2E45; --back-chip:#303754;
      --back-tile:#fff; --back-border:#E3CFA2;
      --pill-bg:rgba(255,255,255,.06); --pill-br:1px solid rgba(255,255,255,.08);
      --pill-active:#6ea8fe; --pill-text:#e7e9f4;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0e1a,#0f1220);color:var(--text);
         font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

    /* ---------- Top nav (bilateral) ---------- */
    .topnav{position:sticky;top:0;left:0;right:0;height:var(--nav-h);
      background:rgba(16,19,36,.95);backdrop-filter:blur(10px);border-bottom:var(--border);
      z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.35)}
    .topnav__inner{
      max-width:1280px;margin:0 auto;padding:10px 16px;
      display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px 12px
    }
    #nav-left{grid-column:1;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;min-width:0}
    .brand{grid-column:2;justify-self:center;font-weight:900;letter-spacing:.4px;color:var(--text);white-space:nowrap}
    .brand span{color:#6ea8fe}
    #nav-right{grid-column:3;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;min-width:0}
    .seg{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .seg-btn{appearance:none;background:var(--pill-bg);border:var(--pill-br);color:var(--muted);
      font-weight:800;font-size:12px;padding:10px 14px;border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-height:36px}
    .seg-btn:hover{color:#fff}
    .seg-btn.active{background:var(--pill-active);color:#0b1020;border-color:var(--pill-active)}
    .field{display:flex;align-items:center;gap:8px}
    .input{appearance:none;background:var(--pill-bg);border:var(--pill-br);color:#e7e9f4;
      padding:10px 12px;border-radius:10px;font:600 13px/1 system-ui;min-width:220px}
    .input::placeholder{color:#9aa1bd}
    .select{appearance:none;background:var(--pill-bg);border:var(--pill-br);color:#e7e9f4;
      padding:10px 12px;border-radius:10px;font:800 12px/1 system-ui}
    .select option{color:#0b1020}

    /* responsive nav */
    @media (max-width:900px){
      .topnav__inner{grid-template-columns:1fr 1fr}
      .brand{grid-column:1 / -1;order:-1;margin-bottom:4px}
      #nav-left{grid-column:1;justify-content:flex-start}
      #nav-right{grid-column:2;justify-content:flex-end}
    }
    @media (max-width:640px){
      .topnav__inner{grid-template-columns:1fr}
      #nav-left,#nav-right{grid-column:1;justify-content:center}
      .input{min-width:160px}
    }

    /* ---------- App layout ---------- */
    .app{padding-top:var(--nav-h)}
    .main{max-width:1280px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(calc(var(--card-w)*var(--thumb-scale) + 24px), 1fr));gap:16px}

    /* ---------- Card UI ---------- */
    .thumb{background:#0f142e;border:var(--border);border-radius:14px;box-shadow:var(--shadow);padding:10px;display:grid;place-items:center;cursor:pointer}
    .scale-wrap{width:calc(var(--card-w)*var(--thumb-scale));height:calc(var(--card-h)*var(--thumb-scale));overflow:hidden;position:relative;perspective:1200px}
    .card{width:var(--card-w);height:var(--card-h);transform:scale(var(--thumb-scale));transform-origin:top left;position:absolute;top:0;left:0}
    .flip{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .6s}
    .thumb:hover .flip,.thumb.flipped .flip{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;border-radius:18px;background:#f5f6fb;box-shadow:0 12px 30px rgba(0,0,0,.35);border:6px solid #fff;overflow:hidden;backface-visibility:hidden}
    .front{display:grid;grid-template-rows:52px 1fr 88px}
    .back{transform:rotateY(180deg);background:var(--back-paper);border:6px solid #fff;color:var(--back-ink);display:grid;grid-template-rows:52px 1fr}
    .header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#fff;border-bottom:1px solid #e7e8f2;color:#0f1220}
    .back .header{background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));border-bottom:1px solid rgba(0,0,0,.06);color:var(--back-ink-2)}
    .chip{background:#1f4aa8;color:#fff;font-weight:800;letter-spacing:.4px;padding:6px 10px;border-radius:999px;font-size:12px}
    .back .chip{background:var(--back-chip)}
    .photo{position:relative;margin:10px;border-radius:12px;overflow:hidden;height:calc(var(--card-h) - 52px - 88px - 20px);background:#0c1026;display:grid;place-items:center}
    .photo img{width:100%;height:100%;object-fit:cover}
    .photo::after{content:"";position:absolute;inset:0;box-shadow:inset 0 -80px 120px rgba(0,0,0,.45)}
    .footer{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;padding:10px;background:#fff;border-top:1px solid #e7e8f2;color:#0f1220}
    .name{font-weight:900;font-size:20px;letter-spacing:.3px;color:#0f1220;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-weight:700;color:#6b7390;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{background:#0f6f3d;color:#dcffe7;font-weight:800;font-size:12px;border-radius:10px;padding:6px 10px}
    .accent{position:absolute;right:-6px;top:0;height:72px;width:140px;background:linear-gradient(180deg,#1f4aa8,#c71f2d);clip-path:polygon(0 0,100% 0,100% 100%,18% 100%);display:grid;align-items:center;justify-items:end;padding-right:10px;color:#fff;font-weight:900;font-size:18px}
    .accent span{transform:translateY(-4px)}
    .badge-chip{position:absolute;left:10px;top:10px;border-radius:999px;padding:6px 10px;font-weight:900;font-size:11px;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .badge-iron{background:#125c2c}.badge-wild{background:#6b1ab4}.badge-rookie{background:#b4551a}
    .stats{padding:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr;overflow:auto}
    .stat.kpis{grid-column:1 / -1;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .kpi{background:var(--back-tile);border:1px solid var(--back-border);border-radius:10px;padding:10px;text-align:center}
    .kpi strong{display:block;color:var(--back-ink-2);font-size:11px;margin-bottom:4px}
    .kpi .v{font-weight:900;font-size:18px}
    .stat{background:var(--back-tile);border:1px solid var(--back-border);border-radius:10px;padding:10px;font-size:12px;color:var(--back-ink)}
    .stat strong{display:block;color:var(--back-ink-2);margin-bottom:4px}
  </style>
</head>

<body>
  <header class="topnav"><div class="topnav__inner">
      <div id="leftControls">
        <div class="field"><input id="searchInput" class="input" type="search" placeholder="Search name" autocomplete="off" /></div>
        <div class="field"><select id="stateSelect" class="select"><option value="all">All States</option><option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option><option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option><option>DC</option></select></div>
        <div class="seg" id="chamberSeg">
          <button class="seg-btn active" data-chamber="all">All</button>
          <button class="seg-btn" data-chamber="senate">Senate</button>
          <button class="seg-btn" data-chamber="house">House</button>
        </div>
      </div>

      <div class="brand">Capitol <span>League</span></div>

      <div id="rightControls">
        <div class="seg" id="partySeg">
          <button class="seg-btn active" data-party="all">All</button>
          <button class="seg-btn" data-party="Dem">Dem</button>
          <button class="seg-btn" data-party="Rep">Rep</button>
          <button class="seg-btn" data-party="Ind">Ind</button>
        </div>
        <div class="seg" id="badgeSeg">
          <button class="seg-btn active" data-badge="all">All Badges</button>
          <button class="seg-btn" data-badge="iron">Ironman</button>
          <button class="seg-btn" data-badge="rookie">Rookie</button>
          <button class="seg-btn" data-badge="wild">Wild Card</button>
        </div>
      </div>
    </div></header>

  <main class="main">
    <div id="cardGrid" class="grid" aria-live="polite"></div>
  </main>

<script>
(function(){
  'use strict';

  /* ===== Config ===== */
  const DATA_URL = 'https://unitedstates.github.io/congress-legislators/legislators-current.json';
  const urlKpi = new URLSearchParams(location.search).get('kpi');
  const KPI_CSV = urlKpi || 'https://raw.githubusercontent.com/jcgodle/capitol-league/main/dist/kpis.csv';

  /* ===== DOM / State ===== */
  const grid = document.getElementById('cardGrid');
  let chamberFilter='all', partyFilter='all', stateFilter='all', badgeFilter='all', searchQuery='';
  let membersAll = [];
  let kpis = {}; // govtrack -> {total,miss}

  /* ===== Utils ===== */
  const IMG = (bioguide)=> 'https://unitedstates.github.io/images/congress/225x275/'+bioguide+'.jpg';
  const stateName = (code)=>({AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia"}[code]||code);
  const partyLabel = (p)=>!p?'':(/^Dem/i.test(p)?'DEMOCRAT':/^Rep/i.test(p)?'REPUBLICAN':/^Ind/i.test(p)?'INDEPENDENT':p.toUpperCase());

  function computeBadge(m){
    const y = parseInt((m.start||'').slice(0,4),10)||0;
    if(/^Ind/i.test(m.party)) return {label:'Wild Card', cls:'badge-wild', key:'wild'};
    if(y && y<=2015) return {label:'Ironman', cls:'badge-iron', key:'iron'};
    if(y>=2023) return {label:'Rookie', cls:'badge-rookie', key:'rookie'};
    return null;
  }

  /* ===== KPI load (CSV) ===== */
  function parseCSV(text){
    // Expect header: govtrack,total_votes,missed_votes
    const rows = text.trim().split(/\r?\n/);
    if(!rows.length) return {};
    const [h,...lines] = rows;
    const map = {};
    for(const line of lines){
      if(!line.trim()) continue;
      const [id,total,miss] = line.split(',').map(s=>s.trim());
      if(id) map[String(id)] = { total: +total||0, miss: +miss||0 };
    }
    return map;
  }
  const kpiReady = fetch(KPI_CSV, {cache:'no-store'}).then(r=>r.ok?r.text():'').then(t=>{ kpis = t? parseCSV(t) : {}; }).catch(()=>{ kpis = {}; });

  function kpiFor(govtrack){
    const e = kpis[String(govtrack)];
    if(!e) return null;
    const cast = Math.max(0, (e.total||0) - (e.miss||0));
    const pct = e.total? (cast/e.total*100) : 0;
    const mp = e.total? (e.miss/e.total*100) : 0;
    return { voted: cast, missed: e.miss||0, votePct: pct, missPct: mp };
  }

  function applyKPIs(card, data){
    const q=(s)=>card.querySelector('[data-kpi="'+s+'"]');
    const set=(el, v)=>{ if(el) el.textContent=v; };
    if(!data){ set(q('votes'),'N/A'); set(q('misses'),'N/A'); set(q('votePct'),'N/A'); set(q('missPct'),'N/A'); return; }
    set(q('votes'), (data.voted||0).toLocaleString());
    set(q('misses'), (data.missed||0).toLocaleString());
    set(q('votePct'), (data.votePct||0).toFixed(1)+'%');
    set(q('missPct'), (data.missPct||0).toFixed(1)+'%');
  }

  /* ===== Cards ===== */
  function cardEl(m){
    const art=document.createElement('article');
    art.className='thumb'; art.tabIndex=0; art.setAttribute('role','button');
    art.dataset.govtrack=m.govtrack||''; art.dataset.name=m.name;

    const badge = computeBadge(m);
    const badgeHTML = badge ? `<div class="badge-chip ${badge.cls}" title="${badge.label}">${badge.label}</div>` : '';
    const startYear = m.careerStart? m.careerStart.slice(0,4):'';

    art.innerHTML = `
      <div class="scale-wrap"><div class="card"><div class="flip">
        <section class="face front">
          <div class="accent"><span>${m.state}</span></div>
          ${badgeHTML}
          <header class="header"><div></div><div class="chip">${partyLabel(m.party)}</div></header>
          <div class="photo">${m.photo?(`<img alt="Portrait of ${m.name.replace(/"/g,'&quot;')}" src="${m.photo}" onerror="this.remove()">`):''}</div>
          <footer class="footer">
            <div>
              <div class="name">${m.name.toUpperCase()}</div>
              <div class="meta">${stateName(m.state)} • Since ${startYear||''}</div>
            </div>
            <div class="badge" data-score-el>+0 pts</div>
          </footer>
        </section>
        <section class="face back">
          <header class="header"><div>Career Stats</div><div class="chip">${m.state}</div></header>
          <div class="stats">
            <div class="stat"><strong>Party</strong> ${m.party}</div>
            <div class="stat"><strong>Chamber</strong> ${m.chamber}</div>
            <div class="stat"><strong>Term</strong> ${m.start||''} → ${m.end||''}</div>
            <div class="stat"><strong>Bioguide</strong> ${m.bioguide||''}</div>
            <div class="stat"><strong>GovTrack</strong> ${m.govtrack||''}</div>
            <div class="stat kpis">
              <div class="kpi"><strong>Career Votes</strong><div class="v" data-kpi="votes">…</div></div>
              <div class="kpi"><strong>Misses</strong><div class="v" data-kpi="misses">…</div></div>
              <div class="kpi"><strong>Vote %</strong><div class="v" data-kpi="votePct">…</div></div>
              <div class="kpi"><strong>Miss %</strong><div class="v" data-kpi="missPct">…</div></div>
            </div>
          </div>
        </section>
      </div></div></div>
    `;
    function hydrateKPIs(){
      const g = art.dataset.govtrack;
      applyKPIs(art, g? kpiFor(g) : null);
    }
    art.addEventListener('click', ()=>{ art.classList.toggle('flipped'); if(art.classList.contains('flipped')) hydrateKPIs(); });
    art.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); art.classList.toggle('flipped'); if(art.classList.contains('flipped')) hydrateKPIs(); }});
    return art;
  }

  function render(list){
    grid.innerHTML='';
    const frag=document.createDocumentFragment();
    list.forEach(m=>frag.appendChild(cardEl(m)));
    grid.appendChild(frag);
  }

  function applyFilters(){
    const q = searchQuery.trim().toLowerCase();
    const out = membersAll.filter(m=>{
      const okC = (chamberFilter==='all') || (chamberFilter==='senate' && m.chamber==='Senate') || (chamberFilter==='house' && m.chamber==='House');
      const okP = (partyFilter==='all') || (partyFilter==='Dem' && /^Dem/i.test(m.party||'')) || (partyFilter==='Rep' && /^Rep/i.test(m.party||'')) || (partyFilter==='Ind' && /^Ind/i.test(m.party||''));
      const okS = (stateFilter==='all') || (m.state===stateFilter);
      let okB = true;
      if(badgeFilter!=='all'){ const b = computeBadge(m); okB = !!b && b.key===badgeFilter; }
      const okQ = !q || (m.name && m.name.toLowerCase().includes(q));
      return okC && okP && okS && okB && okQ;
    });
    render(out);
  }

  /* ===== Data load ===== */
  Promise.all([
    fetch(DATA_URL,{cache:'no-store'}).then(r=>r.json()),
    kpiReady
  ]).then(([list])=>{
    const members = list.map(r=>{
      const id=r.id||{}, name=r.name||{}, terms=r.terms||[], first=terms[0]||{}, last=terms[terms.length-1]||{};
      const chamber = last.type==='sen'?'Senate':(last.type==='rep'?'House':'');
      return {
        bioguide:id.bioguide,
        govtrack:id.govtrack,
        name:(name.official_full||((name.first||'')+' '+(name.last||''))).trim(),
        state:last.state||'',
        party:last.party||'',
        chamber,
        start:last.start,
        careerStart:first.start,
        end:last.end,
        photo:id.bioguide?IMG(id.bioguide):''
      };
    }).filter(m=>m.chamber && m.end && new Date(m.end)>new Date());
    membersAll = members;
    applyFilters();
  }).catch(()=>{
    grid.innerHTML='<div style="opacity:.7">Failed to load roster.</div>';
  });

  /* ===== Controls ===== */
  const chamberSeg = document.getElementById('chamberSeg');
  const partySeg   = document.getElementById('partySeg');
  const badgeSeg   = document.getElementById('badgeSeg');
  const stateSelect= document.getElementById('stateSelect');
  const searchInput= document.getElementById('searchInput');

  chamberSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-chamber]'); if(!b) return;
    chamberFilter = b.dataset.chamber;
    [...chamberSeg.querySelectorAll('.seg-btn')].forEach(x=>x.classList.toggle('active',x===b));
    applyFilters();
  });
  partySeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-party]'); if(!b) return;
    partyFilter = b.dataset.party;
    [...partySeg.querySelectorAll('.seg-btn')].forEach(x=>x.classList.toggle('active',x===b));
    applyFilters();
  });
  badgeSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-badge]'); if(!b) return;
    badgeFilter = b.dataset.badge;
    [...badgeSeg.querySelectorAll('.seg-btn')].forEach(x=>x.classList.toggle('active',x===b));
    applyFilters();
  });
  stateSelect.addEventListener('change', function(){ stateFilter = this.value; applyFilters(); });
  searchInput.addEventListener('input', function(){ searchQuery = this.value||''; applyFilters(); });

})();
</script>
  <script id="kpi-loader">
(() => {
  // 1) Where to load KPIs from: ?kpi=<csv-or-json-url>
  const KPI_URL = new URLSearchParams(location.search).get("kpi")
                || "dist/kpis.csv"; // fallback you generate via Actions

  // 2) Helpers
  const by = sel => Array.from(document.querySelectorAll(sel));
  const attr = (el, k) => el?.getAttribute(k) ?? "";
  const num = v => Number(String(v || "0").replace(/[, ]/g,"")) || 0;
  const pct = (n,d) => (d>0? ((n/d)*100).toFixed(1) : "0.0");

  // 3) Parse CSV (tiny, robust enough for our three columns)
  function parseCSV(text){
    const rows = text.trim().split(/\r?\n/);
    const [h, ...body] = rows;
    const header = h.split(",").map(s=>s.trim());
    const gi = header.findIndex(k=>/govtrack/i.test(k));
    const ti = header.findIndex(k=>/total/i.test(k));
    const mi = header.findIndex(k=>/missed/i.test(k));
    if (gi<0 || ti<0 || mi<0) throw new Error("CSV missing required columns");
    const map = new Map();
    for (const line of body){
      const cols = line.split(","); // our CSV is simple (no quoted commas)
      const id = String(cols[gi]).trim();
      map.set(id, {
        total_votes: num(cols[ti]),
        missed_votes: num(cols[mi]),
      });
    }
    return map;
  }

  // 4) Parse JSON (if you ever point to kpis.json instead)
  async function parseMaybeJSON(res){
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const obj = await res.json();
      const map = new Map();
      for (const [id, v] of Object.entries(obj)) {
        map.set(String(id), {
          total_votes: num(v.total_votes),
          missed_votes: num(v.missed_votes),
        });
      }
      return map;
    } else {
      const txt = await res.text();
      return parseCSV(txt);
    }
  }

  // 5) Load once, keep in memory
  let KPI_MAP = new Map();
  const kpiReady = fetch(KPI_URL, {cache:"no-store"})
    .then(r => { if(!r.ok) throw new Error("KPI fetch failed"); return parseMaybeJSON(r); })
    .then(map => (KPI_MAP = map))
    .catch(err => {
      console.error("KPI load error:", err);
      // Soft-fail: keep empty map, UI will show N/A
      KPI_MAP = new Map();
    });

  // 6) Fill one card’s KPIs
  function fillCardKPIs(card){
    // Expect an element holding the numeric GovTrack ID
    // (you already render it on the back stats panel)
    const gv = card.querySelector('[data-stat="govtrack"]') || card.querySelector('.govtrack');
    if (!gv) return;

    // Normalize the ID (strip spaces etc.)
    const id = (gv.textContent || "").replace(/\D+/g,"");
    if (!id) return;

    const k = KPI_MAP.get(id);
    const total = k?.total_votes ?? 0;
    const missed = k?.missed_votes ?? 0;
    const votePct = pct(total - missed, total);
    const missPct = pct(missed, total);

    const set = (sel, val) => {
      const el = card.querySelector(sel);
      if (el) el.textContent = (val ?? "N/A");
    };

    // Match your markup cells; adjust selectors if yours differ
    set('[data-kpi="total_votes"] .v', total ? total.toLocaleString() : "N/A");
    set('[data-kpi="missed_votes"] .v', total ? missed.toLocaleString() : "N/A");
    set('[data-kpi="vote_pct"] .v', total ? `${votePct}%` : "N/A");
    set('[data-kpi="miss_pct"] .v', total ? `${missPct}%` : "N/A");

    card.dataset.kpiFilled = "1";
  }

  // 7) Fill all visible cards once KPIs are ready
  async function fillAll(){
    await kpiReady;
    by('.card').forEach(c => fillCardKPIs(c));
  }

  // 8) Observe future cards (if your grid lazy-loads or filters)
  const obs = new MutationObserver(muts => {
    for (const m of muts) {
      m.addedNodes.forEach(n => {
        if (n.nodeType === 1) {
          if (n.matches?.('.card')) fillCardKPIs(n);
          n.querySelectorAll?.('.card').forEach(fillCardKPIs);
        }
      });
    }
  });

  // 9) Kick everything off
  document.addEventListener('DOMContentLoaded', () => {
    fillAll();
    obs.observe(document.body, {childList:true, subtree:true});
  });
})();
</script>

</body>
</html>
